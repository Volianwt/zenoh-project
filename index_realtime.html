<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zenoh Real-Time Dashboard</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: #f6f8fa; 
            margin: 40px; 
        }
        .section {
            background-color: #ffffff; 
            border: 1px solid #d1d5da; 
            padding: 16px; 
            border-radius: 6px; 
            margin-bottom: 20px;
        }
        .message {
            padding: 12px;
            margin: 8px 0;
            background-color: #f6f8fa;
            border-left: 4px solid #0366d6;
            font-family: monospace;
            animation: fadeIn 0.3s;
        }
        .message.new {
            background-color: #fff8c5;
            border-left-color: #28a745;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .timestamp {
            color: #586069;
            font-size: 0.85em;
            margin-bottom: 4px;
        }
        .value {
            font-size: 1.1em;
            color: #0366d6;
            font-weight: bold;
        }
        .status {
            color: #28a745;
            font-size: 0.9em;
        }
        .no-new {
            color: #f39c12;
        }
    </style>
</head>
<body>
    <h1>Zenoh Real-Time Dashboard</h1>

    <div class="section">
        <h2>Live Messages on demo/example/**</h2>
        <p class="status">
            Status: <span id="status">Connecting...</span> | 
            Last update: <span id="last-update">-</span> |
            New messages: <span id="new-count">0</span>
        </p>
        <div id="live-messages">
            <p>Waiting for messages...</p>
        </div>
    </div>

    <script>
        const messagesContainer = document.getElementById('live-messages');
        const statusSpan = document.getElementById('status');
        const lastUpdateSpan = document.getElementById('last-update');
        const newCountSpan = document.getElementById('new-count');
        const apiUrl = 'http://localhost:8000/demo/example/**';
        
        // 用 Set 来追踪所有已经显示过的消息（通过 timestamp）
        const seenTimestamps = new Set();
        let messageHistory = [];
        let newMessageCount = 0;

        async function pollMessages() {
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                // Update status
                statusSpan.textContent = 'Connected ✓';
                statusSpan.style.color = '#28a745';
                lastUpdateSpan.textContent = new Date().toLocaleTimeString();
                
                // Check if we have data
                if (data.length === 0) {
                    messagesContainer.innerHTML = '<p>No messages in storage yet. Run z_pub to send messages!</p>';
                    return;
                }
                
                let hasNewMessages = false;
                
                // Process each message
                data.forEach(msg => {
                    // Check if this is a NEW message we haven't seen before
                    if (!seenTimestamps.has(msg.timestamp)) {
                        seenTimestamps.add(msg.timestamp);
                        hasNewMessages = true;
                        newMessageCount++;
                        
                        // Add to history
                        messageHistory.unshift({
                            time: new Date().toLocaleTimeString(),
                            data: msg,
                            isNew: true  // 标记为新消息
                        });
                        
                        // Keep only last 20 messages
                        if (messageHistory.length > 20) {
                            messageHistory = messageHistory.slice(0, 20);
                        }
                    }
                });
                
                // 更新新消息计数
                newCountSpan.textContent = newMessageCount;
                
                // Only update display if there are new messages
                if (hasNewMessages) {
                    updateDisplay();
                    
                    // 2秒后移除"新消息"高亮
                    setTimeout(() => {
                        messageHistory.forEach(msg => msg.isNew = false);
                        updateDisplay();
                    }, 2000);
                } else {
                    // 没有新消息，更新状态但不闪烁
                    if (messageHistory.length === 0) {
                        messagesContainer.innerHTML = '<p class="no-new">Waiting for new messages... (publisher might be stopped)</p>';
                    }
                }
                
            } catch (error) {
                console.error('Poll error:', error);
                statusSpan.textContent = 'Connection Error ✗';
                statusSpan.style.color = '#d73a49';
                messagesContainer.innerHTML = '<p style="color: red;">Failed to connect. Is zenohd running?</p>';
            }
        }

        function updateDisplay() {
            if (messageHistory.length === 0) {
                messagesContainer.innerHTML = '<p>No messages yet...</p>';
                return;
            }
            
            messagesContainer.innerHTML = '';
            
            messageHistory.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = msg.isNew ? 'message new' : 'message';
                messageDiv.innerHTML = `
                    <div class="timestamp">Received at ${msg.time}</div>
                    <strong>Key:</strong> ${msg.data.key}<br>
                    <strong>Value:</strong> <span class="value">${msg.data.value}</span><br>
                    <strong>Encoding:</strong> ${msg.data.encoding}
                `;
                messagesContainer.appendChild(messageDiv);
            });
        }

        // Start polling every 500 milliseconds
        setInterval(pollMessages, 500);
        
        // Run immediately
        pollMessages();
    </script>
</body>
</html>
